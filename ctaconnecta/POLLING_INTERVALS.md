# ‚è±Ô∏è –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ CTA Usuario App

–ê–Ω–∞–ª–∏–∑ —Ç–æ–≥–æ, –∫–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞.

---

## üìä –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

### 1. GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞–≤—Ç–æ–±—É—Å–æ–≤
**–ò–Ω—Ç–µ—Ä–≤–∞–ª: 60 —Å–µ–∫—É–Ω–¥ (1 –º–∏–Ω—É—Ç–∞)**

–ü–æ–ª—É—á–µ–Ω –∏–∑ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:
```bash
GET /Coordinates/GapTimeRefresh
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 60
```

**–ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
```kotlin
class DetailStopViewModelImpl {
    fun trackVehicle(vehicleId: Int) {
        viewModelScope.launch {
            while (isActive) {
                val coords = getVehicleCoordinates(vehicleId)
                updateUI(coords)
                delay(60_000)  // 60 —Å–µ–∫—É–Ω–¥
            }
        }
    }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–Ω–æ–≤–ª—è—Ç—å GPS –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥

---

### 2. –ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è (Arrival Estimates)
**–ò–Ω—Ç–µ—Ä–≤–∞–ª: ~30-60 —Å–µ–∫—É–Ω–¥**

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
- –í—Ä–µ–º–µ–Ω–∏ –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è (–µ—Å–ª–∏ –∞–≤—Ç–æ–±—É—Å –±–ª–∏–∑–∫–æ - —á–∞—â–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞ (–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ - —á–∞—â–µ)

**–¢–∏–ø–∏—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–±—É—Å –¥–∞–ª–µ–∫–æ (>10 –º–∏–Ω): –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ **60 —Å–µ–∫—É–Ω–¥**
- –ê–≤—Ç–æ–±—É—Å –±–ª–∏–∑–∫–æ (<10 –º–∏–Ω): –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ **30 —Å–µ–∫—É–Ω–¥**
- –ê–≤—Ç–æ–±—É—Å –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ (<2 –º–∏–Ω): –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ **15 —Å–µ–∫—É–Ω–¥**

```kotlin
fun getUpdateInterval(minutesAway: Int): Long {
    return when {
        minutesAway < 2 -> 15_000L   // 15 —Å–µ–∫
        minutesAway < 10 -> 30_000L  // 30 —Å–µ–∫
        else -> 60_000L              // 60 —Å–µ–∫
    }
}
```

---

### 3. –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤
**–ò–Ω—Ç–µ—Ä–≤–∞–ª: –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —ç–∫—Ä–∞–Ω / Pull-to-refresh**

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –º–∞—Ä—à—Ä—É—Ç—ã) –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ pull-to-refresh
- –ú–æ–≥—É—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É

---

### 4. Firebase Remote Config
**–ò–Ω—Ç–µ—Ä–≤–∞–ª: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)**

–ù–∞–π–¥–µ–Ω–æ –≤ –∫–æ–¥–µ:
```json
{
  "sla": 600000  // 600 —Å–µ–∫—É–Ω–¥ = 10 –º–∏–Ω—É—Ç
}
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- Feature flags
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîã –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞—Ç–∞—Ä–µ–∏

### WorkManager –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `WorkManager` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:
```kotlin
IMPLICIT_MIN_UPDATE_INTERVAL  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```

**–§–æ–Ω–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–≤—ë—Ä–Ω—É—Ç–æ):**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: **15 –º–∏–Ω—É—Ç** (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Android)
- –¢–∏–ø–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: **15-30 –º–∏–Ω—É—Ç**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–∏–±—ã—Ç–∏–∏

---

## üì± –†–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### 1. –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º (—ç–∫—Ä–∞–Ω –≤–∫–ª—é—á—ë–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ)
```
GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:      –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
–ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è:   –∫–∞–∂–¥—ã–µ 15-60 —Å–µ–∫—É–Ω–¥ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
–°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫:    –ø–æ –∑–∞–ø—Ä–æ—Å—É
```

### 2. –§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–≤—ë—Ä–Ω—É—Ç–æ)
```
GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:      –ù–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
–ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è:   —á–µ—Ä–µ–∑ WorkManager (–∫–∞–∂–¥—ã–µ 15-30 –º–∏–Ω)
Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:    –ø–æ —Å–æ–±—ã—Ç–∏—è–º –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
```

### 3. –≠–∫—Ä–∞–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
```
–í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:      –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:         —Ç–æ–ª—å–∫–æ push –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –Ω–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Backend (Go)

```go
const (
    // GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞–≤—Ç–æ–±—É—Å–æ–≤
    GPSUpdateInterval = 60 * time.Second
    
    // –ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
    ArrivalEstimateMinInterval = 15 * time.Second
    ArrivalEstimateMaxInterval = 60 * time.Second
    
    // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
    StaticDataCacheTTL = 24 * time.Hour
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ConfigUpdateInterval = 10 * time.Minute
)

func GetArrivalUpdateInterval(minutesAway int) time.Duration {
    switch {
    case minutesAway < 2:
        return 15 * time.Second
    case minutesAway < 10:
        return 30 * time.Second
    default:
        return 60 * time.Second
    }
}
```

### Frontend (Svelte)

```typescript
// stores/busTracking.ts
const INTERVALS = {
  GPS_UPDATE: 60_000,           // 60 —Å–µ–∫
  ARRIVAL_CLOSE: 15_000,        // 15 —Å–µ–∫ (–∞–≤—Ç–æ–±—É—Å –±–ª–∏–∑–∫–æ)
  ARRIVAL_MEDIUM: 30_000,       // 30 —Å–µ–∫ (–∞–≤—Ç–æ–±—É—Å —Å—Ä–µ–¥–Ω–µ)
  ARRIVAL_FAR: 60_000,          // 60 —Å–µ–∫ (–∞–≤—Ç–æ–±—É—Å –¥–∞–ª–µ–∫–æ)
} as const;

function startTracking(vehicleId: number) {
  const interval = setInterval(async () => {
    const coords = await fetchVehicleCoordinates(vehicleId);
    updateBusPosition(coords);
  }, INTERVALS.GPS_UPDATE);
  
  return () => clearInterval(interval);
}
```

---

## üö¶ –õ–∏–º–∏—Ç—ã API

–ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä:

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã:
- **GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã**: –ù–µ —á–∞—â–µ 60 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è**: –ù–µ —á–∞—â–µ 15 —Å–µ–∫—É–Ω–¥
- **–û–¥–∏–Ω vehicleId**: –ù–µ –±–æ–ª–µ–µ 1 –∑–∞–ø—Ä–æ—Å–∞ –≤ 60 —Å–µ–∫—É–Ω–¥
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –ù–µ –±–æ–ª–µ–µ 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### Rate Limiting (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–º –≤ –Ω–∞—à API):
```
60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP
1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å –Ω–∞ IP
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å TUA API

| –ü–∞—Ä–∞–º–µ—Ç—Ä | TUA API | CTA API |
|----------|---------|---------|
| **GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** | N/A (–≤—ã—á–∏—Å–ª—è–µ–º) | 60 —Å–µ–∫ |
| **–ü—Ä–æ–≥–Ω–æ–∑—ã –ø—Ä–∏–±—ã—Ç–∏—è** | ~30 —Å–µ–∫ | 15-60 —Å–µ–∫ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) |
| **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ** | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ + –∫–µ—à |
| **–§–æ–Ω–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** | –ù–µ—Ç | WorkManager (15-30 –º–∏–Ω) |

---

## üí° Best Practices

### 1. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
–ß–µ–º –±–ª–∏–∂–µ –∞–≤—Ç–æ–±—É—Å, —Ç–µ–º —á–∞—â–µ –æ–±–Ω–æ–≤–ª—è–µ–º:
```typescript
function getUpdateInterval(minutesAway: number): number {
  if (minutesAway < 2) return 15_000;
  if (minutesAway < 10) return 30_000;
  return 60_000;
}
```

### 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```typescript
let inactivityTimer: ReturnType<typeof setTimeout>;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    stopPolling();
  }, 5 * 60 * 1000);
}

// –°–±—Ä–∞—Å—ã–≤–∞—Ç—å –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.addEventListener('click', resetInactivityTimer);
```

### 3. Exponential Backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
```typescript
let retryCount = 0;

async function fetchWithRetry() {
  try {
    return await fetchData();
  } catch (error) {
    retryCount++;
    const delay = Math.min(1000 * Math.pow(2, retryCount), 60_000);
    await sleep(delay);
    return fetchWithRetry();
  }
}
```

### 4. Deduplicate –∑–∞–ø—Ä–æ—Å–æ–≤
```typescript
const pendingRequests = new Map<string, Promise<any>>();

async function fetchDedup(url: string) {
  if (pendingRequests.has(url)) {
    return pendingRequests.get(url);
  }
  
  const promise = fetch(url).then(r => r.json());
  pendingRequests.set(url, promise);
  
  try {
    return await promise;
  } finally {
    pendingRequests.delete(url);
  }
}
```

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:
```typescript
interface PollingMetrics {
  endpoint: string;
  interval: number;
  requestCount: number;
  errorCount: number;
  avgResponseTime: number;
  lastUpdate: Date;
}

// –ü—Ä–∏–º–µ—Ä
console.log({
  endpoint: '/Coordinates/VehicleCoordinates/12345',
  interval: 60_000,
  requestCount: 150,
  errorCount: 2,
  avgResponseTime: 234,
  lastUpdate: new Date()
});
```

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 16 –¥–µ–∫–∞–±—Ä—è 2024  
**–ò—Å—Ç–æ—á–Ω–∏–∫**: com.iecisa.ctausuario.apk + CTA API testing
